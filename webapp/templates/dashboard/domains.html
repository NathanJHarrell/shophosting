{% extends "dashboard/base_dashboard.html" %}

{% block page_title %}Domains{% endblock %}

{% block dashboard_css %}
.domain-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: 24px;
    overflow: hidden;
}

.domain-card-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.domain-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.domain-card-body {
    padding: 20px 28px;
}

/* Primary Domain Section */
.primary-domain {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
}

.domain-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.domain-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.domain-details h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.domain-details span {
    font-size: 0.85rem;
    color: var(--text-tertiary);
}

.domain-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.domain-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.domain-badge.active {
    background: var(--success-muted);
    color: var(--success);
}

.domain-badge.pending {
    background: var(--warning-muted);
    color: var(--warning);
}

.visit-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
}

.visit-btn:hover {
    background: var(--bg-elevated);
    border-color: var(--border-accent);
}

/* DNS Configuration Section */
.dns-record {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
}

.dns-record:last-child {
    margin-bottom: 0;
}

.dns-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.dns-type {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--accent-blue);
    letter-spacing: 0.05em;
}

.dns-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.dns-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.copy-btn:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.copy-btn.copied {
    background: var(--success-muted);
    color: var(--success);
    border-color: var(--success);
}

/* Health Check Section */
.health-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.health-item {
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    padding: 20px;
    text-align: center;
}

.health-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.health-icon.checking {
    background: var(--bg-elevated);
    color: var(--text-muted);
}

.health-icon.success {
    background: var(--success-muted);
    color: var(--success);
}

.health-icon.warning {
    background: var(--warning-muted);
    color: var(--warning);
}

.health-icon.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.health-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.health-status {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.health-detail {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-top: 4px;
}

/* Info Box */
.info-box {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--info-muted);
    border: 1px solid rgba(0, 136, 255, 0.2);
    border-radius: var(--radius-md);
    margin-bottom: 20px;
}

.info-box-icon {
    flex-shrink: 0;
    color: var(--accent-blue);
}

.info-box-content {
    font-size: 0.9rem;
    color: var(--accent-blue);
}

.info-box-content strong {
    display: block;
    margin-bottom: 4px;
}

/* Refresh Button */
.refresh-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.refresh-btn:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.refresh-btn svg.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* SSL Info */
.ssl-details {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-subtle);
}

.ssl-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 0.875rem;
}

.ssl-label {
    color: var(--text-secondary);
}

.ssl-value {
    color: var(--text-primary);
    font-weight: 500;
}

.ssl-value.warning {
    color: var(--warning);
}

.ssl-value.success {
    color: var(--success);
}

/* Hidden SVG templates */
.svg-templates {
    display: none;
}

/* Cloudflare Integration Styles */
.cloudflare-section {
    margin-bottom: 24px;
}

.cloudflare-connect-card {
    background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-surface) 100%);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: 32px;
    text-align: center;
}

.cloudflare-logo {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    padding: 12px;
    background: #F6821F;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
}

.cloudflare-logo svg {
    width: 40px;
    height: 40px;
    fill: white;
}

.cloudflare-connect-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.cloudflare-connect-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 24px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.connect-cloudflare-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 28px;
    background: #F6821F;
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
}

.connect-cloudflare-btn:hover {
    background: #e5760d;
    transform: translateY(-1px);
}

.cloudflare-signup-link {
    margin-top: 16px;
    font-size: 0.85rem;
    color: var(--text-tertiary);
}

.cloudflare-signup-link a {
    color: var(--accent-blue);
    text-decoration: none;
}

.cloudflare-signup-link a:hover {
    text-decoration: underline;
}

/* Connection Status */
.connection-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--success-muted);
    border: 1px solid var(--success);
    border-radius: var(--radius-md);
    margin-bottom: 20px;
}

.connection-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.connection-icon {
    width: 36px;
    height: 36px;
    background: var(--success);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.connection-text {
    font-size: 0.9rem;
    color: var(--success);
    font-weight: 500;
}

.connection-text span {
    display: block;
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 400;
    margin-top: 2px;
}

.disconnect-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.disconnect-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

/* DNS Management */
.dns-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.dns-actions {
    display: flex;
    gap: 12px;
}

.add-record-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: var(--gradient-primary);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.add-record-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.sync-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.sync-btn:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.sync-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.sync-btn svg.spinning {
    animation: spin 1s linear infinite;
}

/* DNS Records Table */
.dns-table-container {
    overflow-x: auto;
}

.dns-table {
    width: 100%;
    border-collapse: collapse;
}

.dns-table th,
.dns-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-subtle);
}

.dns-table th {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    background: var(--bg-surface);
}

.dns-table td {
    font-size: 0.9rem;
    color: var(--text-primary);
}

.dns-table tbody tr:hover {
    background: var(--bg-surface);
}

.dns-type-badge {
    display: inline-block;
    padding: 4px 10px;
    background: var(--accent-blue);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 4px;
    letter-spacing: 0.02em;
}

.dns-type-badge.mx {
    background: #8b5cf6;
}

.dns-type-badge.cname {
    background: #10b981;
}

.dns-type-badge.txt {
    background: #f59e0b;
}

.dns-type-badge.aaaa {
    background: #6366f1;
}

.dns-name-cell {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
}

.dns-content-cell {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-secondary);
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.proxied-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.proxied-badge.on {
    background: var(--warning-muted);
    color: #f59e0b;
}

.proxied-badge.off {
    background: var(--bg-surface);
    color: var(--text-tertiary);
}

.record-actions {
    display: flex;
    gap: 8px;
}

.record-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s;
}

.record-action-btn:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.record-action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

.empty-records {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.empty-records svg {
    margin-bottom: 12px;
    color: var(--text-muted);
}

/* Manual DNS Fallback Section */
.manual-dns-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-subtle);
}

.manual-dns-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

/* Modals */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalIn 0.2s ease;
}

@keyframes modalIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    padding: 24px 24px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: 8px;
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 0 24px 24px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 20px;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.form-control {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    font-size: 0.95rem;
    color: var(--text-primary);
    transition: all 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(0, 136, 255, 0.12);
}

.form-hint {
    margin-top: 6px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.form-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.domain-suffix {
    padding: 12px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-left: none;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
    white-space: nowrap;
}

.form-row .form-control {
    border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: normal;
    cursor: pointer;
    padding: 12px 14px;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.checkbox-label:hover {
    border-color: var(--border-accent);
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    opacity: 0.9;
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border-default);
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: var(--bg-hover);
}

.btn-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-red);
    border: 1px solid rgba(239, 68, 68, 0.3);
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-danger:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
}

.alert {
    padding: 12px 16px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    margin-bottom: 16px;
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--accent-red);
}

.alert-success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: var(--accent-green);
}

.spinner {
    display: none;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spinAnimation 0.8s linear infinite;
    margin-right: 8px;
}

.btn.loading .spinner {
    display: inline-block;
}

@keyframes spinAnimation {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .health-grid {
        grid-template-columns: 1fr;
    }

    .primary-domain {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
    }

    .domain-actions {
        width: 100%;
        justify-content: space-between;
    }

    .dns-record {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .copy-btn {
        width: 100%;
        justify-content: center;
    }
}
{% endblock %}

{% block dashboard_content %}
<!-- Hidden SVG templates for JavaScript to clone (avoids innerHTML with dynamic content) -->
<div class="svg-templates">
    <svg id="icon-success" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
    <svg id="icon-warning" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    <svg id="icon-error" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
    <svg id="icon-spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning"><path d="M21 12a9 9 0 1 1-9-9"></path></svg>
    <svg id="icon-copy" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    <svg id="icon-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
</div>

<div class="page-header">
    <h1 class="page-title">Domains</h1>
    <p class="page-subtitle">Manage your store's domain settings and DNS configuration.</p>
</div>

<!-- Primary Domain Card -->
<div class="domain-card">
    <div class="domain-card-header">
        <h2 class="domain-card-title">Primary Domain</h2>
    </div>
    <div class="primary-domain">
        <div class="domain-info">
            <div class="domain-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </div>
            <div class="domain-details">
                <h3>{{ customer.domain }}</h3>
                <span>Primary domain for your store</span>
            </div>
        </div>
        <div class="domain-actions">
            <span class="domain-badge active">Active</span>
            <a href="https://{{ customer.domain }}" target="_blank" class="visit-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                Visit Site
            </a>
        </div>
    </div>
</div>

<!-- DNS Configuration Card -->
<div class="domain-card">
    <div class="domain-card-header">
        <h2 class="domain-card-title">DNS Configuration</h2>
    </div>
    <div class="domain-card-body">
        {% if cloudflare_connected %}
        <!-- Connected to Cloudflare - Show DNS Management UI -->
        <div class="connection-status">
            <div class="connection-info">
                <div class="connection-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="connection-text">
                    Connected to Cloudflare
                    {% if last_sync_time %}
                    <span>Last synced: {{ last_sync_time }}</span>
                    {% endif %}
                </div>
            </div>
            <a href="{{ url_for('cloudflare.disconnect') }}" class="disconnect-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Disconnect
            </a>
        </div>

        <div class="dns-header">
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0;">DNS Records</h3>
            <div class="dns-actions">
                <button class="sync-btn" id="sync-dns-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Sync
                </button>
                <button class="add-record-btn" id="add-record-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Record
                </button>
            </div>
        </div>

        {% if dns_records %}
        <div class="dns-table-container">
            <table class="dns-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Content</th>
                        <th>Proxied</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in dns_records %}
                    <tr>
                        <td>
                            <span class="dns-type-badge {{ record.record_type|lower }}">{{ record.record_type }}</span>
                        </td>
                        <td class="dns-name-cell">{{ record.name }}</td>
                        <td class="dns-content-cell" title="{{ record.content }}">{{ record.content }}</td>
                        <td>
                            {% if record.proxied %}
                            <span class="proxied-badge on">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"></circle></svg>
                                On
                            </span>
                            {% else %}
                            <span class="proxied-badge off">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                                Off
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="record-actions">
                                <button class="record-action-btn edit-record-btn"
                                        data-record-id="{{ record.cloudflare_record_id }}"
                                        data-record-type="{{ record.record_type }}"
                                        data-record-name="{{ record.name }}"
                                        data-record-content="{{ record.content }}"
                                        data-record-proxied="{{ 'true' if record.proxied else 'false' }}"
                                        data-record-ttl="{{ record.ttl }}"
                                        data-record-priority="{{ record.priority or '' }}"
                                        title="Edit record">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="record-action-btn delete delete-record-btn"
                                        data-record-id="{{ record.cloudflare_record_id }}"
                                        data-record-type="{{ record.record_type }}"
                                        data-record-name="{{ record.name }}"
                                        title="Delete record">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-records">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <p>No DNS records found. Click "Sync" to fetch records from Cloudflare, or add a new record.</p>
        </div>
        {% endif %}

        <!-- Manual DNS Fallback Section -->
        <div class="manual-dns-section">
            <div class="manual-dns-title">Required DNS Records</div>
            <div class="info-box" style="margin-bottom: 12px;">
                <svg class="info-box-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <div class="info-box-content">
                    Ensure these records exist to point your domain to our servers:
                </div>
            </div>
            <div class="dns-record">
                <div class="dns-info">
                    <span class="dns-type">A Record</span>
                    <span class="dns-name">{{ customer.domain }}</span>
                    <span class="dns-value">Points to: {{ server_ip }}</span>
                </div>
                <button class="copy-btn" data-copy="{{ server_ip }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span class="copy-text">Copy IP</span>
                </button>
            </div>
        </div>

        {% else %}
        <!-- Not Connected - Show Connect Button -->
        <div class="cloudflare-connect-card">
            <div class="cloudflare-logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.5088 16.8447c.1475-.5068.0908-.9707-.1553-1.3154-.2246-.3164-.6045-.502-1.0615-.502H6.5717c-.0625 0-.1182-.0283-.1553-.0732-.0342-.042-.0478-.0986-.0361-.1582.0439-.1885.2129-.3311.4082-.3311h8.7471c.8789 0 1.5313-.4727 1.8516-1.2754.1494-.3574.1562-.7227.0303-1.0703-.0332-.0869-.0879-.1797-.1182-.2686L16.1875 8.2l-.0078-.0225c-.0322-.086-.0986-.2031-.125-.2813-.3369-.752-.9297-1.2236-1.7051-1.2236H5.3164c-.0361 0-.0693.0088-.1006.0195C6.1543 5.1606 8.1299 4.084 10.3438 4.084c3.0947 0 5.6836 2.1602 6.3926 5.0547.3457-.1201.7129-.1973 1.1006-.1973 1.7608 0 3.1875 1.4287 3.1875 3.1895 0 1.7578-1.4287 3.1846-3.1875 3.1846-.7227 0-1.3809-.2422-1.918-.6484.0195.1416.0332.2842.0332.4277 0 .7666-.2676 1.4922-.7549 2.0938-.0156.0186-.0332.0361-.0527.0527z" />
                </svg>
            </div>
            <h3 class="cloudflare-connect-title">Connect Cloudflare</h3>
            <p class="cloudflare-connect-desc">
                Manage your DNS records directly from this dashboard. Connect your Cloudflare account to enable automatic DNS management, DDoS protection, and more.
            </p>
            <a href="{{ url_for('cloudflare.connect') }}" class="connect-cloudflare-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                Connect Cloudflare
            </a>
            <p class="cloudflare-signup-link">
                Don't have a Cloudflare account? <a href="https://dash.cloudflare.com/sign-up" target="_blank" rel="noopener">Sign up for free</a>
            </p>
        </div>

        <!-- Manual DNS Configuration for Non-Connected Users -->
        <div class="manual-dns-section">
            <div class="manual-dns-title">Manual DNS Setup</div>
            <div class="info-box" style="margin-bottom: 12px;">
                <svg class="info-box-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <div class="info-box-content">
                    <strong>DNS Setup Required</strong>
                    Point your domain to our servers by adding these DNS records at your domain registrar (GoDaddy, Namecheap, Cloudflare, etc.)
                </div>
            </div>

            <div class="dns-record">
                <div class="dns-info">
                    <span class="dns-type">A Record</span>
                    <span class="dns-name">{{ customer.domain }}</span>
                    <span class="dns-value">Points to: {{ server_ip }}</span>
                </div>
                <button class="copy-btn" data-copy="{{ server_ip }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span class="copy-text">Copy IP</span>
                </button>
            </div>

            <div class="dns-record">
                <div class="dns-info">
                    <span class="dns-type">A Record (www)</span>
                    <span class="dns-name">www.{{ customer.domain }}</span>
                    <span class="dns-value">Points to: {{ server_ip }}</span>
                </div>
                <button class="copy-btn" data-copy="{{ server_ip }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span class="copy-text">Copy IP</span>
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Domain Health Card -->
<div class="domain-card">
    <div class="domain-card-header">
        <h2 class="domain-card-title">Domain Health</h2>
        <button id="refresh-health" class="refresh-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            Refresh
        </button>
    </div>
    <div class="domain-card-body">
        <div class="health-grid">
            <div class="health-item" id="dns-health">
                <div class="health-icon checking">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning"><path d="M21 12a9 9 0 1 1-9-9"></path></svg>
                </div>
                <div class="health-label">DNS Resolution</div>
                <div class="health-status">Checking...</div>
                <div class="health-detail" id="dns-detail"></div>
            </div>

            <div class="health-item" id="ssl-health">
                <div class="health-icon checking">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning"><path d="M21 12a9 9 0 1 1-9-9"></path></svg>
                </div>
                <div class="health-label">SSL Certificate</div>
                <div class="health-status">Checking...</div>
                <div class="health-detail" id="ssl-detail"></div>
            </div>

            <div class="health-item" id="http-health">
                <div class="health-icon checking">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning"><path d="M21 12a9 9 0 1 1-9-9"></path></svg>
                </div>
                <div class="health-label">HTTPS Connectivity</div>
                <div class="health-status">Checking...</div>
                <div class="health-detail" id="http-detail"></div>
            </div>
        </div>

        <div class="ssl-details" id="ssl-details" style="display: none;">
            <div class="ssl-row">
                <span class="ssl-label">Certificate Issuer</span>
                <span class="ssl-value" id="ssl-issuer">-</span>
            </div>
            <div class="ssl-row">
                <span class="ssl-label">Expiry Date</span>
                <span class="ssl-value" id="ssl-expiry">-</span>
            </div>
            <div class="ssl-row">
                <span class="ssl-label">Days Remaining</span>
                <span class="ssl-value" id="ssl-days">-</span>
            </div>
        </div>
    </div>
</div>

<!-- DNS Record Modal -->
<div class="modal-overlay" id="dns-record-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="dns-modal-title">Add DNS Record</h2>
            <button class="modal-close" data-action="close-modal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <form id="dns-record-form">
            <div class="modal-body">
                <div id="dns-record-alert"></div>

                <input type="hidden" id="dns-record-id" value="">

                <div class="form-group">
                    <label for="dns-record-type">Type</label>
                    <select id="dns-record-type" class="form-control" required>
                        <option value="A">A</option>
                        <option value="CNAME">CNAME</option>
                        <option value="MX">MX</option>
                        <option value="TXT">TXT</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dns-record-name">Name</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="dns-record-name" class="form-control" placeholder="@" required>
                        </div>
                        <span class="domain-suffix" id="dns-domain-suffix">.{{ customer.domain }}</span>
                    </div>
                    <p class="form-hint">Use @ for the root domain, or enter a subdomain name</p>
                </div>

                <div class="form-group">
                    <label for="dns-record-content">Content</label>
                    <input type="text" id="dns-record-content" class="form-control" placeholder="" required>
                    <p class="form-hint" id="dns-content-hint">IP address for A records</p>
                </div>

                <div class="form-group" id="dns-priority-group" style="display: none;">
                    <label for="dns-record-priority">Priority</label>
                    <input type="number" id="dns-record-priority" class="form-control" value="10" min="0" max="65535">
                    <p class="form-hint">Lower values have higher priority (MX records only)</p>
                </div>

                <div class="form-group" id="dns-proxied-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="dns-record-proxied">
                        <span>Proxied through Cloudflare</span>
                    </label>
                    <p class="form-hint">When enabled, traffic is routed through Cloudflare for DDoS protection and caching</p>
                </div>

                <div class="form-group">
                    <label for="dns-record-ttl">TTL (Time to Live)</label>
                    <select id="dns-record-ttl" class="form-control">
                        <option value="1">Auto</option>
                        <option value="60">1 minute</option>
                        <option value="120">2 minutes</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                        <option value="7200">2 hours</option>
                        <option value="18000">5 hours</option>
                        <option value="43200">12 hours</option>
                        <option value="86400">1 day</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-danger" id="dns-delete-btn" style="display: none; margin-right: auto;">
                    Delete
                </button>
                <button type="button" class="btn-secondary" data-action="close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="dns-save-btn">
                    <span class="spinner"></span>
                    Save Record
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="dns-delete-modal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2 style="color: var(--accent-red);">Delete DNS Record</h2>
            <button class="modal-close" data-action="close-delete-modal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="color: var(--text-secondary); font-size: 0.9rem;">
                Are you sure you want to delete this DNS record? This action cannot be undone.
            </p>
            <p style="margin-top: 12px; padding: 12px; background: var(--bg-surface); border-radius: var(--radius-md); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">
                <span id="delete-record-type" style="color: var(--accent-blue); font-weight: 600;"></span>
                <span id="delete-record-name" style="color: var(--text-primary);"></span>
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" data-action="close-delete-modal">Cancel</button>
            <button type="button" class="btn-danger" id="confirm-delete-btn">
                <span class="spinner"></span>
                Delete Record
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
// Copy to clipboard functionality
document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const text = btn.dataset.copy;
        const textEl = btn.querySelector('.copy-text');
        const originalText = textEl.textContent;

        try {
            await navigator.clipboard.writeText(text);
            btn.classList.add('copied');
            textEl.textContent = 'Copied!';
            setTimeout(() => {
                btn.classList.remove('copied');
                textEl.textContent = originalText;
            }, 2000);
        } catch (err) {
            console.error('Copy failed:', err);
        }
    });
});

// Health check icon helper - clones SVG from templates
function setHealthIcon(iconContainer, type) {
    const templateId = 'icon-' + type;
    const template = document.getElementById(templateId);
    if (template) {
        iconContainer.textContent = '';
        iconContainer.appendChild(template.cloneNode(true));
    }
}

function updateHealthItem(id, status, statusText, detail) {
    const item = document.getElementById(id);
    const icon = item.querySelector('.health-icon');
    const statusEl = item.querySelector('.health-status');
    const detailEl = document.getElementById(id.replace('-health', '-detail'));

    icon.className = 'health-icon ' + status;

    // Set appropriate icon
    if (status === 'success') {
        setHealthIcon(icon, 'success');
    } else if (status === 'warning') {
        setHealthIcon(icon, 'warning');
    } else if (status === 'error') {
        setHealthIcon(icon, 'error');
    } else {
        setHealthIcon(icon, 'spinner');
    }

    statusEl.textContent = statusText;
    if (detailEl && detail !== undefined) {
        detailEl.textContent = detail;
    }
}

async function checkDomainHealth() {
    const refreshBtn = document.getElementById('refresh-health');
    const btnIcon = refreshBtn.querySelector('svg');

    refreshBtn.disabled = true;
    btnIcon.classList.add('spinning');

    // Reset to checking state
    updateHealthItem('dns-health', 'checking', 'Checking...', '');
    updateHealthItem('ssl-health', 'checking', 'Checking...', '');
    updateHealthItem('http-health', 'checking', 'Checking...', '');
    document.getElementById('ssl-details').style.display = 'none';

    try {
        const response = await fetch('/api/domain/health', { credentials: 'same-origin' });
        const data = await response.json();

        // Update DNS status
        if (data.dns.status === 'ok') {
            updateHealthItem('dns-health', 'success', 'Properly configured', 'Resolves to ' + data.dns.resolved_ip);
        } else if (data.dns.status === 'misconfigured') {
            updateHealthItem('dns-health', 'warning', 'Misconfigured', 'Points to ' + data.dns.resolved_ip + ' instead of our server');
        } else if (data.dns.status === 'not_found') {
            updateHealthItem('dns-health', 'error', 'Not found', 'Domain does not resolve');
        } else {
            updateHealthItem('dns-health', 'error', 'Error', data.dns.error || 'Check failed');
        }

        // Update SSL status
        if (data.ssl.status === 'valid') {
            updateHealthItem('ssl-health', 'success', 'Valid certificate', 'Issued by ' + data.ssl.issuer);
            document.getElementById('ssl-details').style.display = 'block';
            document.getElementById('ssl-issuer').textContent = data.ssl.issuer || '-';
            document.getElementById('ssl-expiry').textContent = data.ssl.expiry || '-';
            const daysEl = document.getElementById('ssl-days');
            daysEl.textContent = data.ssl.days_remaining !== null ? data.ssl.days_remaining + ' days' : '-';
            daysEl.className = 'ssl-value ' + (data.ssl.days_remaining < 30 ? 'warning' : 'success');
        } else if (data.ssl.status === 'invalid') {
            updateHealthItem('ssl-health', 'error', 'Invalid certificate', data.ssl.error || 'Verification failed');
        } else if (data.ssl.status === 'no_https') {
            updateHealthItem('ssl-health', 'error', 'No HTTPS', 'Port 443 not accessible');
        } else {
            updateHealthItem('ssl-health', 'warning', 'Unknown', data.ssl.error || 'Could not check');
        }

        // Update HTTP status
        if (data.http.status === 'ok') {
            updateHealthItem('http-health', 'success', 'Connected', 'HTTP ' + (data.http.status_code || 200));
        } else {
            updateHealthItem('http-health', 'error', 'Not reachable', data.http.error || 'Connection failed');
        }

    } catch (error) {
        updateHealthItem('dns-health', 'error', 'Error', 'Failed to check');
        updateHealthItem('ssl-health', 'error', 'Error', 'Failed to check');
        updateHealthItem('http-health', 'error', 'Error', 'Failed to check');
    }

    refreshBtn.disabled = false;
    btnIcon.classList.remove('spinning');
}

document.getElementById('refresh-health').addEventListener('click', checkDomainHealth);

// Check health on page load
checkDomainHealth();

// ===========================================
// DNS Record Modal Functionality
// ===========================================

var currentDomain = '{{ customer.domain }}';
var currentRecordId = null;
var deleteRecordId = null;

// Modal functions
function openDnsModal(mode, recordData) {
    var modal = document.getElementById('dns-record-modal');
    var title = document.getElementById('dns-modal-title');
    var deleteBtn = document.getElementById('dns-delete-btn');
    var form = document.getElementById('dns-record-form');

    // Clear any previous alerts
    clearDnsAlert();

    // Reset form
    form.reset();
    document.getElementById('dns-record-id').value = '';
    currentRecordId = null;

    if (mode === 'add') {
        title.textContent = 'Add DNS Record';
        deleteBtn.style.display = 'none';
        // Set defaults
        document.getElementById('dns-record-type').value = 'A';
        document.getElementById('dns-record-ttl').value = '1';
        updateFieldsForType('A');
    } else if (mode === 'edit' && recordData) {
        title.textContent = 'Edit DNS Record';
        deleteBtn.style.display = 'block';
        currentRecordId = recordData.id;
        document.getElementById('dns-record-id').value = recordData.id;

        // Populate form with record data
        document.getElementById('dns-record-type').value = recordData.type;
        document.getElementById('dns-record-name').value = recordData.name === currentDomain ? '@' : recordData.name.replace('.' + currentDomain, '');
        document.getElementById('dns-record-content').value = recordData.content;
        document.getElementById('dns-record-priority').value = recordData.priority || 10;
        document.getElementById('dns-record-proxied').checked = recordData.proxied || false;
        document.getElementById('dns-record-ttl').value = String(recordData.ttl || 1);

        updateFieldsForType(recordData.type);
    }

    modal.classList.add('open');
}

function closeDnsModal() {
    document.getElementById('dns-record-modal').classList.remove('open');
    currentRecordId = null;
}

function openDeleteModal(recordId, recordType, recordName) {
    deleteRecordId = recordId;
    document.getElementById('delete-record-type').textContent = recordType + ' ';
    document.getElementById('delete-record-name').textContent = recordName;
    document.getElementById('dns-delete-modal').classList.add('open');
}

function closeDeleteModal() {
    document.getElementById('dns-delete-modal').classList.remove('open');
    deleteRecordId = null;
}

// Update form fields based on record type
function updateFieldsForType(type) {
    var priorityGroup = document.getElementById('dns-priority-group');
    var proxiedGroup = document.getElementById('dns-proxied-group');
    var contentHint = document.getElementById('dns-content-hint');
    var contentInput = document.getElementById('dns-record-content');

    // Show/hide priority for MX records
    if (type === 'MX') {
        priorityGroup.style.display = 'block';
    } else {
        priorityGroup.style.display = 'none';
    }

    // Show/hide proxied for A and CNAME records
    if (type === 'A' || type === 'CNAME') {
        proxiedGroup.style.display = 'block';
    } else {
        proxiedGroup.style.display = 'none';
        document.getElementById('dns-record-proxied').checked = false;
    }

    // Update content hint and placeholder based on type
    switch (type) {
        case 'A':
            contentHint.textContent = 'IPv4 address (e.g., 192.0.2.1)';
            contentInput.placeholder = '192.0.2.1';
            break;
        case 'CNAME':
            contentHint.textContent = 'Target domain name (e.g., example.com)';
            contentInput.placeholder = 'example.com';
            break;
        case 'MX':
            contentHint.textContent = 'Mail server hostname (e.g., mail.example.com)';
            contentInput.placeholder = 'mail.example.com';
            break;
        case 'TXT':
            contentHint.textContent = 'Text content (e.g., SPF record, verification string)';
            contentInput.placeholder = 'v=spf1 include:_spf.example.com ~all';
            break;
        default:
            contentHint.textContent = '';
            contentInput.placeholder = '';
    }
}

// Alert functions
function showDnsAlert(message, type) {
    var container = document.getElementById('dns-record-alert');
    container.textContent = '';
    var alertEl = document.createElement('div');
    alertEl.className = 'alert alert-' + type;
    alertEl.textContent = message;
    container.appendChild(alertEl);
}

function clearDnsAlert() {
    document.getElementById('dns-record-alert').textContent = '';
}

// Set loading state
function setDnsLoading(loading) {
    var btn = document.getElementById('dns-save-btn');
    if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
    } else {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// Form submission
async function saveDnsRecord(e) {
    e.preventDefault();
    setDnsLoading(true);
    clearDnsAlert();

    var recordId = document.getElementById('dns-record-id').value;
    var recordType = document.getElementById('dns-record-type').value;
    var recordName = document.getElementById('dns-record-name').value.trim();
    var recordContent = document.getElementById('dns-record-content').value.trim();
    var recordPriority = parseInt(document.getElementById('dns-record-priority').value) || 10;
    var recordProxied = document.getElementById('dns-record-proxied').checked;
    var recordTtl = parseInt(document.getElementById('dns-record-ttl').value) || 1;

    // Build full name
    var fullName;
    if (recordName === '@' || recordName === '') {
        fullName = currentDomain;
    } else {
        fullName = recordName + '.' + currentDomain;
    }

    // Prepare request body
    var body = {
        type: recordType,
        name: fullName,
        content: recordContent,
        ttl: recordTtl
    };

    // Add priority for MX records
    if (recordType === 'MX') {
        body.priority = recordPriority;
    }

    // Add proxied for A and CNAME records
    if (recordType === 'A' || recordType === 'CNAME') {
        body.proxied = recordProxied;
    }

    try {
        var url, method;
        if (recordId) {
            // Update existing record
            url = '/dashboard/cloudflare/api/records/' + recordId;
            method = 'PUT';
        } else {
            // Create new record
            url = '/dashboard/cloudflare/api/records';
            method = 'POST';
        }

        var response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(body)
        });

        var data = await response.json();

        if (data.success || response.ok) {
            showDnsAlert(recordId ? 'Record updated successfully!' : 'Record created successfully!', 'success');
            setTimeout(function() {
                closeDnsModal();
                refreshDnsRecords();
            }, 1000);
        } else {
            showDnsAlert(data.error || data.message || 'Failed to save record', 'error');
        }
    } catch (err) {
        console.error('Error saving DNS record:', err);
        showDnsAlert('An error occurred. Please try again.', 'error');
    } finally {
        setDnsLoading(false);
    }
}

// Delete record
async function deleteDnsRecord() {
    if (!deleteRecordId) return;

    var btn = document.getElementById('confirm-delete-btn');
    btn.classList.add('loading');
    btn.disabled = true;

    try {
        var response = await fetch('/dashboard/cloudflare/api/records/' + deleteRecordId, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        });

        var data = await response.json();

        if (data.success || response.ok) {
            closeDeleteModal();
            closeDnsModal();
            refreshDnsRecords();
        } else {
            alert(data.error || data.message || 'Failed to delete record');
        }
    } catch (err) {
        console.error('Error deleting DNS record:', err);
        alert('An error occurred. Please try again.');
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// Refresh DNS records table (reload page for now, can be enhanced later)
function refreshDnsRecords() {
    location.reload();
}

// Event Listeners
document.getElementById('dns-record-type').addEventListener('change', function(e) {
    updateFieldsForType(e.target.value);
});

document.getElementById('dns-record-form').addEventListener('submit', saveDnsRecord);

document.getElementById('dns-delete-btn').addEventListener('click', function() {
    if (currentRecordId) {
        var recordType = document.getElementById('dns-record-type').value;
        var recordName = document.getElementById('dns-record-name').value || '@';
        openDeleteModal(currentRecordId, recordType, recordName + '.' + currentDomain);
    }
});

document.getElementById('confirm-delete-btn').addEventListener('click', deleteDnsRecord);

// Close modal buttons
document.querySelectorAll('[data-action="close-modal"]').forEach(function(btn) {
    btn.addEventListener('click', closeDnsModal);
});

document.querySelectorAll('[data-action="close-delete-modal"]').forEach(function(btn) {
    btn.addEventListener('click', closeDeleteModal);
});

// Close modals on overlay click
document.getElementById('dns-record-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDnsModal();
    }
});

document.getElementById('dns-delete-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDnsModal();
        closeDeleteModal();
    }
});

// Expose functions globally for use by other scripts (e.g., from records table)
window.openDnsModal = openDnsModal;
window.closeDnsModal = closeDnsModal;
window.openDeleteModal = openDeleteModal;
window.closeDeleteModal = closeDeleteModal;

// ===========================================
// Cloudflare DNS Management
// ===========================================

{% if cloudflare_connected %}
// Add Record Button
var addRecordBtn = document.getElementById('add-record-btn');
if (addRecordBtn) {
    addRecordBtn.addEventListener('click', function() {
        openDnsModal('add');
    });
}

// Sync DNS Records Button
var syncBtn = document.getElementById('sync-dns-btn');
if (syncBtn) {
    syncBtn.addEventListener('click', async function() {
        var btnIcon = syncBtn.querySelector('svg');
        syncBtn.disabled = true;
        btnIcon.classList.add('spinning');

        try {
            var response = await fetch('/dashboard/cloudflare/api/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin'
            });

            var data = await response.json();

            if (data.success || response.ok) {
                // Reload the page to show updated records
                location.reload();
            } else {
                alert(data.error || data.message || 'Failed to sync DNS records');
                syncBtn.disabled = false;
                btnIcon.classList.remove('spinning');
            }
        } catch (err) {
            console.error('Error syncing DNS records:', err);
            alert('An error occurred while syncing. Please try again.');
            syncBtn.disabled = false;
            btnIcon.classList.remove('spinning');
        }
    });
}

// Edit Record Buttons
document.querySelectorAll('.edit-record-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var recordData = {
            id: btn.dataset.recordId,
            type: btn.dataset.recordType,
            name: btn.dataset.recordName,
            content: btn.dataset.recordContent,
            proxied: btn.dataset.recordProxied === 'true',
            ttl: parseInt(btn.dataset.recordTtl) || 1,
            priority: btn.dataset.recordPriority ? parseInt(btn.dataset.recordPriority) : null
        };
        openDnsModal('edit', recordData);
    });
});

// Delete Record Buttons
document.querySelectorAll('.delete-record-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var recordId = btn.dataset.recordId;
        var recordType = btn.dataset.recordType;
        var recordName = btn.dataset.recordName;
        openDeleteModal(recordId, recordType, recordName);
    });
});
{% endif %}
{% endblock %}
