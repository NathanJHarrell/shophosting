{% extends "dashboard/base_dashboard.html" %}

{% block page_title %}Backups{% endblock %}

{% block dashboard_css %}
.section-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: 24px;
    overflow: hidden;
}

.section-header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border-subtle);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.section-body {
    padding: 20px 28px;
}

.backup-options {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.backup-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    color: var(--text-secondary);
}

.backup-option input[type="radio"] {
    accent-color: var(--accent-blue);
    width: 16px;
    height: 16px;
}

.backup-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.backup-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.backup-date {
    font-weight: 500;
    color: var(--text-primary);
}

.backup-type {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.backup-actions {
    position: relative;
}

.restore-dropdown {
    position: absolute;
    right: 0;
    top: 100%;
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 180px;
    z-index: 100;
    display: none;
}

.restore-dropdown.show {
    display: block;
}

.restore-option {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    color: var(--text-secondary);
}

.restore-option:hover {
    background: var(--bg-surface);
    color: var(--text-primary);
}

.btn {
    padding: 10px 20px;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    font-size: 0.9rem;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border-subtle);
}

.btn-secondary:hover {
    background: var(--bg-elevated);
    border-color: var(--border-accent);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.status-banner {
    padding: 16px 20px;
    border-radius: var(--radius-md);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.status-banner.running {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: var(--text-primary);
}

.status-banner.failed {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
}

.failed-icon {
    font-size: 1.2rem;
}

.dismiss-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 1rem;
    opacity: 0.7;
}

.dismiss-btn:hover {
    opacity: 1;
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-subtle);
    border-top-color: var(--accent-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

/* Modal styles */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-overlay.show {
    display: flex;
}

.modal {
    background: var(--bg-elevated);
    border-radius: var(--radius-lg);
    padding: 24px;
    max-width: 450px;
    width: 90%;
}

.modal-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-primary);
}

.modal-body {
    margin-bottom: 20px;
    color: var(--text-secondary);
}

.modal-input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    background: var(--bg-surface);
    color: var(--text-primary);
    margin-top: 12px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.warning-text {
    color: #ef4444;
    font-size: 0.9rem;
}

@media (max-width: 640px) {
    .backup-options {
        flex-direction: column;
        gap: 12px;
    }

    .backup-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .backup-actions {
        width: 100%;
    }

    .backup-actions .btn {
        width: 100%;
    }
}
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Backups</h1>
    <p class="page-subtitle">Manage your store backups and restoration points.</p>
</div>

{% if active_job %}
<div class="status-banner running" id="status-banner">
    <div class="spinner"></div>
    <span id="status-text">
        {% if active_job.job_type == 'backup' %}
            Creating backup...
        {% else %}
            Restoring from backup...
        {% endif %}
    </span>
</div>
{% endif %}

{% set most_recent_job = recent_jobs[0] if recent_jobs else none %}
{% if most_recent_job and most_recent_job.status == 'failed' and not active_job %}
<div class="status-banner failed" id="failed-banner">
    <span class="failed-icon">&#10006;</span>
    <span>
        {% if most_recent_job.job_type == 'backup' %}
            Backup failed{% if most_recent_job.error_message %}: {{ most_recent_job.error_message[:100] }}{% endif %}
        {% else %}
            Restore failed{% if most_recent_job.error_message %}: {{ most_recent_job.error_message[:100] }}{% endif %}
        {% endif %}
    </span>
    <button class="dismiss-btn" onclick="this.parentElement.remove()">&#10005;</button>
</div>
{% endif %}

<!-- Create Backup Section -->
<div class="section-card">
    <div class="section-header">
        <span class="section-title">Create Manual Backup</span>
    </div>
    <div class="section-body">
        <form id="backup-form">
            <div class="backup-options">
                <label class="backup-option">
                    <input type="radio" name="backup_type" value="db">
                    <span>Database only</span>
                </label>
                <label class="backup-option">
                    <input type="radio" name="backup_type" value="files">
                    <span>Files only</span>
                </label>
                <label class="backup-option">
                    <input type="radio" name="backup_type" value="both" checked>
                    <span>Database & Files</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary" id="create-backup-btn" {% if active_job %}disabled{% endif %}>
                Create Backup
            </button>
        </form>
    </div>
</div>

<!-- Manual Backups Section -->
<div class="section-card">
    <div class="section-header">
        <span class="section-title">Manual Backups</span>
        <span style="color: var(--text-secondary); font-size: 0.9rem;">Max 5 kept</span>
    </div>
    <div class="section-body">
        {% if manual_backups %}
        <div class="backup-list">
            {% for backup in manual_backups %}
            <div class="backup-item">
                <div class="backup-info">
                    <span class="backup-date">{{ backup.time[:19] | replace('T', ' ') }}</span>
                    <span class="backup-type">
                        {% if 'both' in backup.tags %}Database & Files
                        {% elif 'db' in backup.tags %}Database only
                        {% elif 'files' in backup.tags %}Files only
                        {% else %}Full backup{% endif %}
                    </span>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-secondary restore-toggle" data-snapshot="{{ backup.id }}" data-source="manual" {% if active_job %}disabled{% endif %}>
                        Restore
                    </button>
                    <div class="restore-dropdown" id="dropdown-{{ backup.id }}">
                        <div class="restore-option" data-type="db">Database only</div>
                        <div class="restore-option" data-type="files">Files only</div>
                        <div class="restore-option" data-type="both">Full restore</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>No manual backups yet. Create one above.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Daily Backups Section -->
<div class="section-card">
    <div class="section-header">
        <span class="section-title">Daily Backups</span>
        <span style="color: var(--text-secondary); font-size: 0.9rem;">Last 30 days</span>
    </div>
    <div class="section-body">
        {% if daily_backups %}
        <div class="backup-list">
            {% for backup in daily_backups %}
            <div class="backup-item">
                <div class="backup-info">
                    <span class="backup-date">{{ backup.time[:19] | replace('T', ' ') }}</span>
                    <span class="backup-type">Full backup (automatic)</span>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-secondary restore-toggle" data-snapshot="{{ backup.id }}" data-source="daily" {% if active_job %}disabled{% endif %}>
                        Restore
                    </button>
                    <div class="restore-dropdown" id="dropdown-{{ backup.id }}">
                        <div class="restore-option" data-type="db">Database only</div>
                        <div class="restore-option" data-type="files">Files only</div>
                        <div class="restore-option" data-type="both">Full restore</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>No daily backups available yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal-overlay" id="restore-modal">
    <div class="modal">
        <div class="modal-title">Confirm Restore</div>
        <div class="modal-body">
            <p>This will restore your site from the selected backup. Your site will be put into maintenance mode during the restore.</p>
            <p class="warning-text" style="margin-top: 12px;">This action cannot be undone. Any changes made after this backup will be lost.</p>
            <input type="text" class="modal-input" id="restore-confirmation" placeholder="Type RESTORE to confirm">
            <input type="hidden" id="restore-snapshot-id">
            <input type="hidden" id="restore-type">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-restore">Cancel</button>
            <button class="btn btn-primary" id="confirm-restore">Restore</button>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
const csrfToken = '{{ csrf_token() }}';

// Create backup form
document.getElementById('backup-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const backupType = document.querySelector('input[name="backup_type"]:checked').value;
    const btn = document.getElementById('create-backup-btn');

    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
        const formData = new FormData();
        formData.append('backup_type', backupType);

        const response = await fetch('/backups/create', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to start backup');
            btn.disabled = false;
            btn.textContent = 'Create Backup';
        }
    } catch (err) {
        alert('An error occurred');
        btn.disabled = false;
        btn.textContent = 'Create Backup';
    }
});

// Restore dropdown toggles
document.querySelectorAll('.restore-toggle').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const snapshotId = btn.dataset.snapshot;
        const dropdown = document.getElementById('dropdown-' + snapshotId);

        // Close all other dropdowns
        document.querySelectorAll('.restore-dropdown').forEach(d => {
            if (d !== dropdown) d.classList.remove('show');
        });

        dropdown.classList.toggle('show');
    });
});

// Close dropdowns when clicking outside
document.addEventListener('click', () => {
    document.querySelectorAll('.restore-dropdown').forEach(d => d.classList.remove('show'));
});

// Restore option clicks
document.querySelectorAll('.restore-option').forEach(opt => {
    opt.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = opt.closest('.restore-dropdown');
        const snapshotId = dropdown.id.replace('dropdown-', '');
        const restoreType = opt.dataset.type;

        document.getElementById('restore-snapshot-id').value = snapshotId;
        document.getElementById('restore-type').value = restoreType;
        document.getElementById('restore-confirmation').value = '';
        document.getElementById('restore-modal').classList.add('show');

        dropdown.classList.remove('show');
    });
});

// Modal cancel
document.getElementById('cancel-restore').addEventListener('click', () => {
    document.getElementById('restore-modal').classList.remove('show');
});

// Modal confirm
document.getElementById('confirm-restore').addEventListener('click', async () => {
    const confirmation = document.getElementById('restore-confirmation').value;
    const snapshotId = document.getElementById('restore-snapshot-id').value;
    const restoreType = document.getElementById('restore-type').value;

    if (confirmation !== 'RESTORE') {
        alert('Please type RESTORE to confirm');
        return;
    }

    const btn = document.getElementById('confirm-restore');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
        const formData = new FormData();
        formData.append('confirmation', confirmation);
        formData.append('restore_type', restoreType);

        const response = await fetch(`/backups/${snapshotId}/restore`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to start restore');
            btn.disabled = false;
            btn.textContent = 'Restore';
        }
    } catch (err) {
        alert('An error occurred');
        btn.disabled = false;
        btn.textContent = 'Restore';
    }
});

// Poll for status updates if there's an active job
{% if active_job %}
setInterval(async () => {
    try {
        const response = await fetch('/api/backups/status');
        const data = await response.json();

        if (!data.has_active_job) {
            // Check if there was a failure
            if (data.last_failed) {
                const banner = document.getElementById('status-banner');
                if (banner) {
                    banner.className = 'status-banner failed';
                    banner.textContent = '';

                    const icon = document.createElement('span');
                    icon.className = 'failed-icon';
                    icon.textContent = '\u2716';

                    const msg = document.createElement('span');
                    const jobType = data.last_failed.job_type === 'backup' ? 'Backup' : 'Restore';
                    const errorMsg = data.last_failed.error_message || 'Unknown error';
                    msg.textContent = jobType + ' failed: ' + errorMsg.substring(0, 100);

                    const dismissBtn = document.createElement('button');
                    dismissBtn.className = 'dismiss-btn';
                    dismissBtn.textContent = '\u2715';
                    dismissBtn.onclick = () => location.reload();

                    banner.appendChild(icon);
                    banner.appendChild(msg);
                    banner.appendChild(dismissBtn);

                    // Re-enable the create backup button
                    const btn = document.getElementById('create-backup-btn');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Create Backup';
                    }
                }
            } else {
                location.reload();
            }
        }
    } catch (err) {
        console.error('Status poll failed:', err);
    }
}, 5000);
{% endif %}
{% endblock %}
