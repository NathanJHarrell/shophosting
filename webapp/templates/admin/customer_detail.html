{% extends "admin/base_admin.html" %}

{% block title %}Customer: {{ customer.email }}{% endblock %}
{% block page_title %}Customer Details{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <a href="{{ url_for('admin.customers') }}" class="btn btn-secondary btn-sm">Back to Customers</a>
    <div style="display: flex; gap: 12px;">
        <a href="{{ url_for('admin.edit_customer', customer_id=customer.id) }}" class="btn btn-secondary btn-sm">Edit Customer</a>
        {% if customer.status in ['failed', 'pending'] %}
            <form method="POST" action="{{ url_for('admin.customer_retry_provisioning', customer_id=customer.id) }}" style="display: inline;" onsubmit="return confirm('This will restart the provisioning process. Continue?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-primary btn-sm">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Retry Provisioning
                </button>
            </form>
        {% endif %}
        {% if customer.status == 'suspended' %}
            <form method="POST" action="{{ url_for('admin.customer_reactivate', customer_id=customer.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-primary btn-sm">Reactivate</button>
            </form>
        {% elif customer.status == 'active' %}
            <form method="POST" action="{{ url_for('admin.customer_suspend', customer_id=customer.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to suspend this customer?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger btn-sm">Suspend</button>
            </form>
        {% endif %}
        <form method="POST" action="{{ url_for('admin.delete_customer', customer_id=customer.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this customer? This will remove all containers and data. This cannot be undone.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger btn-sm">Delete Customer</button>
        </form>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <!-- Customer Info -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Customer Information</h3>
            <span class="badge badge-{{ customer.status }}">{{ customer.status }}</span>
        </div>
        <div class="card-body">
            <table style="width: 100%;">
                <tr>
                    <td class="text-muted" style="padding: 8px 0; width: 140px;">ID</td>
                    <td class="mono">{{ customer.id }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Email</td>
                    <td>{{ customer.email }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Company</td>
                    <td>{{ customer.company_name }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Domain</td>
                    <td class="mono">
                        <a href="https://{{ customer.domain }}" target="_blank" style="color: var(--accent-blue);">{{ customer.domain }}</a>
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Platform</td>
                    <td><span class="badge badge-info">{{ customer.platform }}</span></td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Port</td>
                    <td class="mono">{{ customer.web_port or 'Not assigned' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Server</td>
                    <td>
                        {% set server = customer.get_server() %}
                        {% if server %}
                            <a href="{{ url_for('admin.server_detail', server_id=server.id) }}" style="color: var(--accent-cyan); text-decoration: none;">
                                {{ server.name }}
                            </a>
                            <span class="text-muted" style="font-size: 0.85rem;">({{ server.hostname }})</span>
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Created</td>
                    <td>{{ customer.created_at.strftime('%Y-%m-%d %H:%M') if customer.created_at else '-' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Updated</td>
                    <td>{{ customer.updated_at.strftime('%Y-%m-%d %H:%M') if customer.updated_at else '-' }}</td>
                </tr>
            </table>

            {% if customer.error_message %}
            <div style="margin-top: 20px; padding: 16px; background: var(--error-muted); border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong class="text-error">Error:</strong>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleErrorDetails('customer-error')" style="font-size: 0.75rem; padding: 4px 8px;">
                        Expand
                    </button>
                </div>
                <pre id="customer-error" class="error-details" style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: var(--radius-sm); overflow-x: auto; white-space: pre-wrap; word-break: break-word; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.8rem; color: var(--text-error); max-height: 150px; overflow-y: auto;">{{ customer.error_message }}</pre>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Store Credentials -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Store Credentials</h3>
        </div>
        <div class="card-body">
            {% if customer.status == 'active' %}
            <table style="width: 100%;">
                <tr>
                    <td class="text-muted" style="padding: 8px 0; width: 140px;">Store URL</td>
                    <td>
                        <a href="https://{{ customer.domain }}" target="_blank" class="mono" style="color: var(--accent-blue);">https://{{ customer.domain }}</a>
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Admin URL</td>
                    <td>
                        {% if customer.platform == 'woocommerce' %}
                            <a href="https://{{ customer.domain }}/wp-admin" target="_blank" class="mono" style="color: var(--accent-blue);">https://{{ customer.domain }}/wp-admin</a>
                        {% else %}
                            <a href="https://{{ customer.domain }}/admin" target="_blank" class="mono" style="color: var(--accent-blue);">https://{{ customer.domain }}/admin</a>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Admin User</td>
                    <td class="mono">{{ customer.admin_user or 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Admin Password</td>
                    <td class="mono">{{ customer.admin_password or 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">DB Name</td>
                    <td class="mono">{{ customer.db_name or 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">DB User</td>
                    <td class="mono">{{ customer.db_user or 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">DB Password</td>
                    <td class="mono">{{ customer.db_password or 'N/A' }}</td>
                </tr>
            </table>
            {% else %}
            <p class="text-muted">Credentials will be available once the store is active.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Monitoring Status -->
{% if monitoring_status and customer.status == 'active' %}
<div class="card" style="margin-top: 24px;">
    <div class="card-header">
        <h3 class="card-title">Monitoring Status</h3>
        <a href="{{ url_for('admin.monitoring_detail', customer_id=customer.id) }}" class="btn btn-secondary btn-sm">View Details</a>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 24px;">
            <!-- HTTP Status -->
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">HTTP Status</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if monitoring_status.http_status == 'healthy' %}
                        <span style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: inline-block;"></span>
                        <span style="color: var(--success); font-weight: 500;">Healthy</span>
                    {% elif monitoring_status.http_status == 'degraded' %}
                        <span style="width: 10px; height: 10px; background: var(--warning); border-radius: 50%; display: inline-block;"></span>
                        <span style="color: var(--warning); font-weight: 500;">Degraded</span>
                    {% elif monitoring_status.http_status == 'down' %}
                        <span style="width: 10px; height: 10px; background: var(--error); border-radius: 50%; display: inline-block;"></span>
                        <span style="color: var(--error); font-weight: 500;">Down</span>
                    {% else %}
                        <span style="width: 10px; height: 10px; background: var(--text-muted); border-radius: 50%; display: inline-block;"></span>
                        <span class="text-muted">Unknown</span>
                    {% endif %}
                </div>
                {% if monitoring_status.last_http_check %}
                <div class="text-muted" style="font-size: 0.75rem; margin-top: 4px;">
                    {{ monitoring_status.last_http_check.strftime('%H:%M:%S') }}
                </div>
                {% endif %}
            </div>

            <!-- Container Status -->
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">Container</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    {% if monitoring_status.container_status == 'running' %}
                        <span style="width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: inline-block;"></span>
                        <span style="color: var(--success); font-weight: 500;">Running</span>
                    {% elif monitoring_status.container_status == 'stopped' %}
                        <span style="width: 10px; height: 10px; background: var(--error); border-radius: 50%; display: inline-block;"></span>
                        <span style="color: var(--error); font-weight: 500;">Stopped</span>
                    {% else %}
                        <span style="width: 10px; height: 10px; background: var(--text-muted); border-radius: 50%; display: inline-block;"></span>
                        <span class="text-muted">Unknown</span>
                    {% endif %}
                </div>
            </div>

            <!-- Response Time -->
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">Response Time</div>
                {% if monitoring_status.last_http_response_ms %}
                    {% set response_ms = monitoring_status.last_http_response_ms %}
                    <div style="font-weight: 600; font-size: 1.1rem; color: {% if response_ms < 500 %}var(--success){% elif response_ms < 1500 %}var(--warning){% else %}var(--error){% endif %};">
                        {{ response_ms }}ms
                    </div>
                {% else %}
                    <div class="text-muted">-</div>
                {% endif %}
            </div>

            <!-- Uptime -->
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">Uptime (24h)</div>
                {% if monitoring_status.uptime_24h is not none %}
                    {% set uptime = monitoring_status.uptime_24h | float %}
                    <div style="font-weight: 600; font-size: 1.1rem; color: {% if uptime >= 99.5 %}var(--success){% elif uptime >= 95 %}var(--warning){% else %}var(--error){% endif %};">
                        {{ "%.2f"|format(uptime) }}%
                    </div>
                {% else %}
                    <div class="text-muted">-</div>
                {% endif %}
            </div>

            <!-- Resource Usage -->
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 8px;">Resources</div>
                {% if monitoring_status.cpu_percent is not none or monitoring_status.memory_percent is not none %}
                    <div style="display: flex; gap: 12px; font-size: 0.9rem;">
                        {% if monitoring_status.cpu_percent is not none %}
                        <span title="CPU Usage" style="color: {% if monitoring_status.cpu_percent > 80 %}var(--warning){% else %}var(--text-primary){% endif %};">
                            <strong>CPU:</strong> {{ "%.1f"|format(monitoring_status.cpu_percent) }}%
                        </span>
                        {% endif %}
                        {% if monitoring_status.memory_percent is not none %}
                        <span title="Memory Usage" style="color: {% if monitoring_status.memory_percent > 80 %}var(--warning){% else %}var(--text-primary){% endif %};">
                            <strong>Mem:</strong> {{ "%.1f"|format(monitoring_status.memory_percent) }}%
                        </span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-muted">-</div>
                {% endif %}
            </div>
        </div>

        {% if monitoring_status.consecutive_failures > 0 %}
        <div style="margin-top: 16px; padding: 12px 16px; background: var(--warning-muted); border-radius: var(--radius-md); border: 1px solid rgba(245, 158, 11, 0.25);">
            <span style="color: var(--warning); font-weight: 500;">
                âš  {{ monitoring_status.consecutive_failures }} consecutive failure{{ 's' if monitoring_status.consecutive_failures > 1 else '' }}
            </span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Active Alerts -->
{% if monitoring_alerts %}
<div class="card" style="margin-top: 24px;">
    <div class="card-header">
        <h3 class="card-title">Recent Alerts</h3>
        <span class="badge badge-warning">{{ monitoring_alerts | length }}</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Message</th>
                    <th>Status</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in monitoring_alerts %}
                <tr>
                    <td>
                        <span class="badge badge-{{ 'error' if alert.alert_type in ['http_down', 'container_stopped'] else 'warning' }}">
                            {{ alert.alert_type | replace('_', ' ') | title }}
                        </span>
                    </td>
                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ alert.message }}
                    </td>
                    <td>
                        {% if alert.acknowledged %}
                            <span class="badge badge-success">Acknowledged</span>
                        {% else %}
                            <span class="badge badge-warning">Active</span>
                        {% endif %}
                    </td>
                    <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') if alert.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Subscription -->
{% if subscription %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Subscription</h3>
        <span class="badge badge-{{ subscription.status }}">{{ subscription.status }}</span>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 4px;">Plan</div>
                <div>{{ subscription.plan_name or 'Unknown' }}</div>
            </div>
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 4px;">Period Start</div>
                <div>{{ subscription.current_period_start.strftime('%Y-%m-%d') if subscription.current_period_start else '-' }}</div>
            </div>
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 4px;">Period End</div>
                <div>{{ subscription.current_period_end.strftime('%Y-%m-%d') if subscription.current_period_end else '-' }}</div>
            </div>
            <div>
                <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 4px;">Stripe ID</div>
                <div class="mono">{{ subscription.stripe_subscription_id or '-' }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Provisioning Jobs -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Provisioning History</h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Finished</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td class="mono">{{ job.job_id[:12] }}...</td>
                    <td><span class="badge badge-{{ job.status }}">{{ job.status }}</span></td>
                    <td>{{ job.started_at.strftime('%Y-%m-%d %H:%M') if job.started_at else '-' }}</td>
                    <td>{{ job.finished_at.strftime('%Y-%m-%d %H:%M') if job.finished_at else '-' }}</td>
                    <td style="max-width: 400px;">
                        {% if job.error_message %}
                        <div class="error-cell">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="text-error error-preview" id="preview-{{ loop.index }}" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; display: inline-block;">{{ job.error_message[:80] }}{% if job.error_message|length > 80 %}...{% endif %}</span>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleJobError({{ loop.index }})" style="font-size: 0.7rem; padding: 2px 6px; flex-shrink: 0;">
                                    View
                                </button>
                            </div>
                            <pre id="job-error-{{ loop.index }}" class="error-details" style="display: none; margin-top: 8px; padding: 10px; background: var(--error-muted); border-radius: var(--radius-sm); overflow-x: auto; white-space: pre-wrap; word-break: break-word; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.75rem; color: var(--text-error); max-height: 200px; overflow-y: auto; border: 1px solid rgba(239, 68, 68, 0.2);">{{ job.error_message }}</pre>
                        </div>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-muted">No provisioning jobs</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Live Provisioning Logs -->
{% if in_progress_job and provisioning_logs %}
<div class="card" id="provisioning-logs-card">
    <div class="card-header">
        <h3 class="card-title">
            <span style="display: flex; align-items: center; gap: 8px;">
                Live Provisioning Progress
                <span class="pulse-indicator"></span>
            </span>
        </h3>
        <button type="button" class="btn btn-secondary btn-sm" onclick="refreshProvisioningLogs()" style="font-size: 0.75rem;">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            Refresh
        </button>
    </div>
    <div class="card-body" style="padding: 0;">
        <div id="provisioning-logs-container" style="max-height: 400px; overflow-y: auto; background: #1a1a2e; padding: 16px; margin: 0;">
            {% for log in provisioning_logs %}
            <div class="log-entry log-{{ log.log_level|lower }}" style="padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.8rem;">
                <span class="log-time" style="color: #6b7280; margin-right: 12px;">{{ log.created_at.strftime('%H:%M:%S') }}</span>
                <span class="log-level" style="font-weight: 600; margin-right: 8px;
                    {% if log.log_level == 'INFO' %}color: #10b981;{% endif %}
                    {% if log.log_level == 'WARNING' %}color: #f59e0b;{% endif %}
                    {% if log.log_level == 'ERROR' %}color: #ef4444;{% endif %}
                    {% if log.log_level == 'DEBUG' %}color: #6b7280;{% endif %}
                ">[{{ log.log_level }}]</span>
                <span class="log-message" style="color: #e5e7eb;">{{ log.message }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Invoices -->
{% if invoices %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Invoices</h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Invoice ID</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Paid</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td class="mono">{{ invoice.stripe_invoice_id[:20] }}...</td>
                    <td>${{ "%.2f"|format(invoice.amount_due / 100) }}</td>
                    <td><span class="badge badge-{{ 'success' if invoice.status == 'paid' else 'warning' }}">{{ invoice.status }}</span></td>
                    <td>{{ invoice.created_at.strftime('%Y-%m-%d') if invoice.created_at else '-' }}</td>
                    <td>{{ invoice.paid_at.strftime('%Y-%m-%d') if invoice.paid_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Audit Log -->
{% if audit_logs %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Activity Log</h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Details</th>
                    <th>IP Address</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audit_logs %}
                <tr>
                    <td>{{ log.action }}</td>
                    <td class="text-muted" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ log.details or '-' }}</td>
                    <td class="mono">{{ log.ip_address or '-' }}</td>
                    <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script nonce="{{ csp_nonce() }}">
function toggleErrorDetails(id) {
    var el = document.getElementById(id);
    var btn = el.previousElementSibling.querySelector('button') || el.parentElement.querySelector('button');
    if (el.style.maxHeight === '150px' || el.style.maxHeight === '') {
        el.style.maxHeight = 'none';
        if (btn) btn.textContent = 'Collapse';
    } else {
        el.style.maxHeight = '150px';
        if (btn) btn.textContent = 'Expand';
    }
}

function toggleJobError(index) {
    var preview = document.getElementById('preview-' + index);
    var details = document.getElementById('job-error-' + index);
    var btn = preview.parentElement.querySelector('button');

    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        preview.style.display = 'none';
        if (btn) btn.textContent = 'Hide';
    } else {
        details.style.display = 'none';
        preview.style.display = 'inline-block';
        if (btn) btn.textContent = 'View';
    }
}

function refreshProvisioningLogs() {
    var customerId = {{ customer.id }};
    fetch('/admin/api/provisioning-logs/' + customerId)
        .then(response => response.json())
        .then(data => {
            if (data.logs && data.logs.length > 0) {
                var container = document.getElementById('provisioning-logs-container');
                container.innerHTML = '';
                data.logs.forEach(function(log) {
                    var div = document.createElement('div');
                    div.className = 'log-entry log-' + log.log_level.toLowerCase();
                    div.style.cssText = 'padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: Monaco, Menlo, Ubuntu Mono, monospace; font-size: 0.8rem;';

                    var time = document.createElement('span');
                    time.className = 'log-time';
                    time.style.cssText = 'color: #6b7280; margin-right: 12px;';
                    var date = new Date(log.created_at);
                    time.textContent = date.toISOString().split('T')[1].split('.')[0];

                    var level = document.createElement('span');
                    level.className = 'log-level';
                    level.style.cssText = 'font-weight: 600; margin-right: 8px;';
                    if (log.log_level === 'INFO') level.style.color = '#10b981';
                    else if (log.log_level === 'WARNING') level.style.color = '#f59e0b';
                    else if (log.log_level === 'ERROR') level.style.color = '#ef4444';
                    else if (log.log_level === 'DEBUG') level.style.color = '#6b7280';
                    level.textContent = '[' + log.log_level + ']';

                    var message = document.createElement('span');
                    message.className = 'log-message';
                    message.style.cssText = 'color: #e5e7eb;';
                    message.textContent = log.message;

                    div.appendChild(time);
                    div.appendChild(level);
                    div.appendChild(message);
                    container.appendChild(div);
                });
            }
        })
        .catch(error => console.error('Error refreshing logs:', error));
}

var logRefreshInterval = null;
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('provisioning-logs-card')) {
        logRefreshInterval = setInterval(refreshProvisioningLogs, 5000);
    }

    document.querySelectorAll('.error-details').forEach(function(el) {
        var text = el.textContent.trim();
        if (text.startsWith('{') || text.startsWith('[')) {
            try {
                var parsed = JSON.parse(text);
                el.textContent = JSON.stringify(parsed, null, 2);
            } catch(e) {
            }
        }
        else if (text.includes('Traceback') || text.includes('  File "')) {
            el.style.whiteSpace = 'pre';
        }
    });
});

window.addEventListener('beforeunload', function() {
    if (logRefreshInterval) {
        clearInterval(logRefreshInterval);
    }
});
</script>
{% endblock %}
