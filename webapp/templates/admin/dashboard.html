{% extends "admin/base_admin.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Quick Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Quick Actions</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
            <!-- External Links -->
            <a href="{{ url_for('admin.manage_customers') }}" class="btn btn-primary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Manage Customers
            </a>
            <a href="http://147.135.8.170:9000/" target="_blank" class="btn btn-secondary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"></path></svg>
                Portainer
            </a>
            <a href="https://dashboard.stripe.com" target="_blank" class="btn btn-secondary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                Stripe Dashboard
            </a>

            <!-- Service Actions -->
            <div style="border-left: 1px solid var(--border-default); margin: 0 8px;"></div>

            <form method="POST" action="{{ url_for('admin.restart_service', service='shophosting-webapp') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Restart webapp service?')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Restart Webapp
                </button>
            </form>
            <form method="POST" action="{{ url_for('admin.restart_service', service='provisioning-worker') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Restart worker service?')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Restart Worker
                </button>
            </form>

            <form method="POST" action="{{ url_for('admin.run_backup') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Run backup now? This may take several minutes.')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Run Backup
                </button>
            </form>

            <form method="POST" action="{{ url_for('admin.clear_failed_jobs') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" onclick="return confirm('Clear all failed jobs from the queue?')">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Clear Failed Jobs
                </button>
            </form>

            <!-- Logs -->
            <div style="border-left: 1px solid var(--border-default); margin: 0 8px;"></div>

            <a href="{{ url_for('admin.view_logs', log_type='webapp') }}" class="btn btn-secondary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Webapp Logs
            </a>
            <a href="{{ url_for('admin.view_logs', log_type='worker') }}" class="btn btn-secondary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Worker Logs
            </a>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Customers</div>
        <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Active</div>
        <div class="stat-value success">{{ stats.active }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Provisioning</div>
        <div class="stat-value info">{{ stats.provisioning }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Failed</div>
        <div class="stat-value error">{{ stats.failed }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Port Usage</div>
        <div class="stat-value">{{ port_usage.used }}/{{ port_usage.total }}</div>
        <div class="progress mt-4">
            <div class="progress-bar" style="width: {{ (port_usage.used / port_usage.total * 100)|round }}%"></div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Queue Depth</div>
        <div class="stat-value {% if queue_stats.queued > 0 %}warning{% endif %}">{{ queue_stats.queued }}</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <!-- Recent Customers -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Customers</h3>
            <a href="{{ url_for('admin.customers') }}" class="btn btn-secondary btn-sm">View All</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Domain</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in recent_customers %}
                    <tr>
                        <td>
                            <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}" style="color: var(--text-primary); text-decoration: none;">
                                {{ customer.email }}
                            </a>
                        </td>
                        <td class="mono text-muted">{{ customer.domain }}</td>
                        <td><span class="badge badge-{{ customer.status }}">{{ customer.status }}</span></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-muted">No customers yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Failed Provisions -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Failed Provisions</h3>
            <a href="{{ url_for('admin.provisioning') }}" class="btn btn-secondary btn-sm">View Queue</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in failed_customers %}
                    <tr>
                        <td>
                            <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}" style="color: var(--text-primary); text-decoration: none;">
                                {{ customer.email }}
                            </a>
                        </td>
                        <td class="text-error" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ customer.error_message or 'Unknown error' }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="2" class="text-muted">No failed provisions</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">Queue Status</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; gap: 40px;">
            <div>
                <span class="text-muted">Queued:</span>
                <strong>{{ queue_stats.queued }}</strong>
            </div>
            <div>
                <span class="text-muted">Running:</span>
                <strong>{{ queue_stats.started }}</strong>
            </div>
            <div>
                <span class="text-muted">Completed:</span>
                <strong class="text-success">{{ queue_stats.finished }}</strong>
            </div>
            <div>
                <span class="text-muted">Failed:</span>
                <strong class="text-error">{{ queue_stats.failed }}</strong>
            </div>
            <div>
                <span class="text-muted">Redis:</span>
                {% if queue_stats.connected %}
                    <span class="text-success">Connected</span>
                {% else %}
                    <span class="text-error">Disconnected</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce() }}">
// Auto-refresh dashboard every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
