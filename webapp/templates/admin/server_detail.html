{% extends "admin/base_admin.html" %}

{% block title %}{{ server.name }} - Server{% endblock %}
{% block page_title %}{{ server.name }}{% endblock %}

{% block content %}
<!-- Server Info Card -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Server Information</h3>
            <div style="display: flex; gap: 8px;">
                <a href="{{ url_for('admin.server_edit', server_id=server.id) }}" class="btn btn-ghost btn-sm">Edit</a>
                <form action="{{ url_for('admin.server_toggle_maintenance', server_id=server.id) }}" method="POST" style="display: inline;">
                    {% if server.status == 'maintenance' %}
                        <button type="submit" class="btn btn-success btn-sm">Activate</button>
                    {% else %}
                        <button type="submit" class="btn btn-warning btn-sm">Maintenance</button>
                    {% endif %}
                </form>
            </div>
        </div>
        <div class="card-body">
            <table style="width: 100%;">
                <tr>
                    <td class="text-muted" style="padding: 8px 0; width: 150px;">Name</td>
                    <td style="font-weight: 500;">{{ server.name }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Hostname</td>
                    <td class="mono">{{ server.hostname }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">IP Address</td>
                    <td class="mono">{{ server.ip_address }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Status</td>
                    <td>
                        {% if server.status == 'active' %}
                            <span class="badge badge-success">Active</span>
                        {% elif server.status == 'maintenance' %}
                            <span class="badge badge-warning">Maintenance</span>
                        {% else %}
                            <span class="badge badge-error">Offline</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Health</td>
                    <td>
                        {% if server.is_healthy() %}
                            <span class="status-dot online"></span>
                            <span class="text-success">Healthy</span>
                            {% if server.last_heartbeat %}
                            <span class="text-muted" style="font-size: 0.85rem;">(last heartbeat: {{ server.last_heartbeat.strftime('%H:%M:%S') }})</span>
                            {% endif %}
                        {% else %}
                            <span class="status-dot offline"></span>
                            <span class="text-error">Unhealthy</span>
                            {% if server.last_heartbeat %}
                            <span class="text-muted" style="font-size: 0.85rem;">(last heartbeat: {{ server.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') }})</span>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Queue Name</td>
                    <td class="mono">{{ server.get_queue_name() }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Port Range</td>
                    <td class="mono">{{ server.port_range_start }} - {{ server.port_range_end }}</td>
                </tr>
                <tr>
                    <td class="text-muted" style="padding: 8px 0;">Created</td>
                    <td>{{ server.created_at.strftime('%Y-%m-%d %H:%M') if server.created_at else 'N/A' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Capacity Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Capacity</h3>
        </div>
        <div class="card-body">
            {% set customer_count = customers|length %}
            {% set utilization = (customer_count / server.max_customers * 100)|round(1) if server.max_customers > 0 else 0 %}

            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; font-weight: 700; color: var(--accent-cyan);">{{ customer_count }}</div>
                <div class="text-muted">of {{ server.max_customers }} customers</div>
            </div>

            <div class="progress" style="height: 12px; margin-bottom: 16px;">
                <div class="progress-bar" style="width: {{ utilization }}%;
                    {% if utilization > 80 %}background: var(--error);
                    {% elif utilization > 60 %}background: var(--warning);
                    {% endif %}"></div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span class="text-muted">{{ utilization }}% utilized</span>
                <span class="text-success">{{ server.max_customers - customer_count }} available</span>
            </div>

            <hr style="border-color: var(--border-subtle); margin: 20px 0;">

            <h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">Port Usage</h4>
            {% set port_util = (port_info.used / port_info.total * 100)|round(1) if port_info.total > 0 else 0 %}

            <div class="progress" style="height: 8px; margin-bottom: 8px;">
                <div class="progress-bar" style="width: {{ port_util }}%;
                    {% if port_util > 80 %}background: var(--error);
                    {% elif port_util > 60 %}background: var(--warning);
                    {% endif %}"></div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                <span class="text-muted">{{ port_info.used }} used</span>
                <span class="text-muted">{{ port_info.available }} available</span>
            </div>
        </div>
    </div>
</div>

<!-- Customers on this Server -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Customers on this Server</h3>
        <span class="text-muted">{{ customers|length }} customers</span>
    </div>
    <div class="card-body">
        {% if customers %}
        <table class="table">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Domain</th>
                    <th>Platform</th>
                    <th>Status</th>
                    <th>Port</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>
                        <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}" style="color: var(--accent-cyan); text-decoration: none;">
                            {{ customer.company_name or customer.email }}
                        </a>
                        <div class="text-muted" style="font-size: 0.85rem;">{{ customer.email }}</div>
                    </td>
                    <td class="mono">{{ customer.domain }}</td>
                    <td>
                        {% if customer.platform == 'woocommerce' %}
                            <span class="badge" style="background: #9b5de5;">WooCommerce</span>
                        {% else %}
                            <span class="badge" style="background: #f77f00;">Magento</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if customer.status == 'active' %}
                            <span class="badge badge-success">Active</span>
                        {% elif customer.status == 'provisioning' %}
                            <span class="badge badge-info">Provisioning</span>
                        {% elif customer.status == 'failed' %}
                            <span class="badge badge-error">Failed</span>
                        {% elif customer.status == 'suspended' %}
                            <span class="badge badge-warning">Suspended</span>
                        {% else %}
                            <span class="badge">{{ customer.status }}</span>
                        {% endif %}
                    </td>
                    <td class="mono">{{ customer.web_port }}</td>
                    <td>{{ customer.created_at.strftime('%Y-%m-%d') if customer.created_at else 'N/A' }}</td>
                    <td>
                        <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}" class="btn btn-ghost btn-sm">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p class="text-muted">No customers on this server yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Danger Zone -->
{% if customers|length == 0 %}
<div class="card" style="border-color: var(--error);">
    <div class="card-header">
        <h3 class="card-title" style="color: var(--error);">Danger Zone</h3>
    </div>
    <div class="card-body">
        <p class="text-muted mb-4">Once you delete a server, there is no going back. Please be certain.</p>
        <form action="{{ url_for('admin.server_delete', server_id=server.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this server?');">
            <button type="submit" class="btn btn-error">Delete Server</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
