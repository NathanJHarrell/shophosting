{% extends "admin/base_admin.html" %}

{% block title %}Mailboxes{% endblock %}
{% block page_title %}Mailboxes{% endblock %}

{% block content %}
<!-- Header with New Mailbox button -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">All Mailboxes</h2>
    <a href="{{ url_for('admin.mail.create_mailbox') }}" class="btn btn-primary">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
        New Mailbox
    </a>
</div>

<!-- Filters -->
<form method="GET" class="filters">
    <input type="text" name="search" class="form-control" placeholder="Search email..." value="{{ search }}">
    <select name="status" class="form-control">
        <option value="">All Statuses</option>
        <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Disabled</option>
        <option value="system" {% if status == 'system' %}selected{% endif %}>System Users</option>
    </select>
    <button type="submit" class="btn btn-secondary">Filter</button>
    {% if search or status %}
        <a href="{{ url_for('admin.mail.mailboxes') }}" class="btn btn-secondary">Clear</a>
    {% endif %}
</form>

<!-- Results count -->
<p class="text-muted mb-4">Showing {{ mailboxes|length }} of {{ total }} mailboxes</p>

<!-- Mailbox Table -->
<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Quota</th>
                    <th>Usage</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for mailbox in mailboxes %}
                <tr>
                    <td class="mono">{{ mailbox.email }}</td>
                    <td>
                        {% if mailbox.is_system_user %}
                            <span class="badge badge-suspended">System</span>
                        {% else %}
                            <span class="badge badge-info">Virtual</span>
                        {% endif %}
                    </td>
                    <td class="mono">{{ mailbox.quota_mb }} MB</td>
                    <td style="min-width: 150px;">
                        {% set usage_mb = (mailbox.disk_usage / 1024 / 1024)|round(1) if mailbox.disk_usage else 0 %}
                        {% set usage_percent = (usage_mb / mailbox.quota_mb * 100)|round if mailbox.quota_mb > 0 else 0 %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="progress" style="flex: 1; height: 6px;">
                                <div class="progress-bar" style="width: {{ usage_percent }}%; {% if usage_percent > 90 %}background: var(--error);{% elif usage_percent > 75 %}background: var(--warning);{% endif %}"></div>
                            </div>
                            <span class="text-muted" style="font-size: 0.8rem;">{{ usage_percent }}%</span>
                        </div>
                    </td>
                    <td>
                        {% if mailbox.is_active %}
                            <span class="badge badge-active">Active</span>
                        {% else %}
                            <span class="badge badge-suspended">Disabled</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <a href="{{ url_for('admin.mail.edit_mailbox', mailbox_id=mailbox.id) }}" class="btn btn-secondary btn-sm">Edit</a>
                            <form method="POST" action="{{ url_for('admin.mail.delete_mailbox', mailbox_id=mailbox.id) }}" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this mailbox? This action cannot be undone.')">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-muted text-center">No mailboxes found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('admin.mail.mailboxes', page=page-1, search=search, status=status) }}">Previous</a>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
            <span class="active">{{ p }}</span>
        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <a href="{{ url_for('admin.mail.mailboxes', page=p, search=search, status=status) }}">{{ p }}</a>
        {% elif p == page - 3 or p == page + 3 %}
            <span>...</span>
        {% endif %}
    {% endfor %}

    {% if page < total_pages %}
        <a href="{{ url_for('admin.mail.mailboxes', page=page+1, search=search, status=status) }}">Next</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
