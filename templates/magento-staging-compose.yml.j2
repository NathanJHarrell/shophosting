{# Staging environment compose file for Magento #}
{% set container_prefix = "customer-" ~ customer_id ~ "-staging-" ~ staging_number %}

services:
  varnish:
    image: varnish:7.4
    container_name: {{ container_prefix }}-varnish
    restart: unless-stopped
    ports:
      - "{{ web_port }}:80"
    environment:
      VARNISH_BACKEND_HOST: web
      VARNISH_BACKEND_PORT: 80
      VARNISH_SIZE: 128m
    volumes:
      - ./volumes/varnish/default.vcl:/etc/varnish/default.vcl:ro
    depends_on:
      - web
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: 0.25
    networks:
      - {{ container_prefix }}-network

  web:
    image: localhost:5050/magento:latest
    container_name: {{ container_prefix }}-web
    user: root
    restart: unless-stopped
    expose:
      - "80"
    environment:
      MAGENTO_DATABASE_HOST: db
      MAGENTO_DATABASE_NAME: "{{ db_name }}"
      MAGENTO_DATABASE_USER: "{{ db_user }}"
      MAGENTO_DATABASE_PASSWORD: "{{ db_password | replace('$', '$$') }}"
      MAGENTO_HOST: "{{ staging_domain }}"
      ELASTICSEARCH_HOST: elasticsearch
      ELASTICSEARCH_PORT: 9200
      VARNISH_ENABLED: "true"
      VARNISH_HOST: varnish
      VARNISH_PORT: 80
      MAGE_MODE: "developer"
    volumes:
      - ./volumes/files:/var/www/html
    depends_on:
      db:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: 0.75
    networks:
      - {{ container_prefix }}-network

  db:
    image: mysql:8.0
    container_name: {{ container_prefix }}-db
    restart: unless-stopped
    command: --log-bin-trust-function-creators=1
    environment:
      MYSQL_DATABASE: "{{ db_name }}"
      MYSQL_USER: "{{ db_user }}"
      MYSQL_PASSWORD: "{{ db_password | replace('$', '$$') }}"
      MYSQL_ROOT_PASSWORD: "{{ db_root_password | replace('$', '$$') }}"
    volumes:
      - ./volumes/db:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: 0.5
    networks:
      - {{ container_prefix }}-network

  elasticsearch:
    image: elasticsearch:7.17.9
    container_name: {{ container_prefix }}-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
      - xpack.security.enabled=false
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\"'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: 0.25
    networks:
      - {{ container_prefix }}-network

  redis:
    image: redis:alpine
    container_name: {{ container_prefix }}-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128m
          cpus: 0.25
    networks:
      - {{ container_prefix }}-network

networks:
  {{ container_prefix }}-network:
    driver: bridge
