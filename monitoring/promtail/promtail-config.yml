# Promtail Configuration for ShopHosting.io
# Promtail is an agent which ships the contents of local logs to Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ShopHosting Webapp logs
  - job_name: webapp
    static_configs:
      - targets:
          - localhost
        labels:
          job: shophosting-webapp
          __path__: /var/log/shophosting/webapp*.log

  # ShopHosting Worker logs
  - job_name: workers
    static_configs:
      - targets:
          - localhost
        labels:
          job: shophosting-workers
          __path__: /var/log/shophosting/*-worker*.log

  # ShopHosting General logs
  - job_name: shophosting
    static_configs:
      - targets:
          - localhost
        labels:
          job: shophosting
          __path__: /var/log/shophosting/*.log
    pipeline_stages:
      - match:
          selector: '{job="shophosting"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (?P<logger>\w+) - (?P<level>\w+) - (?P<message>.*)$'
            - labels:
                level:
                logger:

  # Nginx access logs
  - job_name: nginx-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          log_type: access
          __path__: /var/log/nginx/*-access.log
    pipeline_stages:
      - regex:
          expression: '^(?P<remote_addr>[\d.]+) - (?P<remote_user>\S+) \[(?P<time_local>[^\]]+)\] "(?P<request>[^"]*)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
      - labels:
          status:

  # Nginx error logs
  - job_name: nginx-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          log_type: error
          __path__: /var/log/nginx/*-error.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.*)$'
      - labels:
          level:

  # Customer container logs (via Docker)
  - job_name: customer-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
        filters:
          - name: label
            values: ["shophosting.customer"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_label_shophosting_customer']
        target_label: 'customer_id'
      - source_labels: ['__meta_docker_container_label_shophosting_service']
        target_label: 'service'

  # Systemd journal for system services
  - job_name: journal
    journal:
      max_age: 12h
      labels:
        job: systemd-journal
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        target_label: 'unit'
      - source_labels: ['__journal_syslog_identifier']
        target_label: 'syslog_identifier'
    pipeline_stages:
      - match:
          selector: '{job="systemd-journal"}'
          stages:
            - regex:
                expression: '(?P<level>error|warn|warning|info|debug)'
            - labels:
                level:
